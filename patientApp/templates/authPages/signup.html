{% extends "base-auth.html" %}

{% block title %}Sign Up - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
  /* ==================== MINIMAL CUSTOM STYLES ==================== */
  body {
    background-color: #f9fafb;
  }

  .signup-container {
    min-height: calc(100vh - 72px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem 0;
  }

  .signup-card {
    max-width: 480px;
    width: 100%;
  }

  .password-toggle {
    cursor: pointer;
    color: #6b7280;
  }

  .password-toggle:hover {
    color: #1d4ed8;
  }

  /* Date input styling */
  input[type="date"] {
    position: relative;
    cursor: pointer;
  }

  /* Calendar icon styling */
  input[type="date"]::-webkit-calendar-picker-indicator {
    cursor: pointer;
    opacity: 0.6;
    font-size: 1.1rem;
  }

  input[type="date"]::-webkit-calendar-picker-indicator:hover {
    opacity: 1;
  }

  /* Remove default date input clear button */
  input[type="date"]::-webkit-clear-button {
    display: none;
  }

  /* Checked radio/checkbox color */
  .form-check-input:checked {
    background-color: #ff7b00;
    border-color: #ff7b00;
  }

  @media (max-width: 576px) {
    .signup-container {
      padding: 1rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container signup-container">
  <div class="signup-card">
    
    <!-- Card -->
    <div class="card border-0 shadow-sm rounded-3">
      <div class="card-body p-4 p-md-5">
        
        <!-- Header -->
        <div class="text-center mb-4">
          <h2 class="fw-bold mb-2" id="signup-title" style="text-align: left;">Sign Up</h2>
          <p class="text-muted mb-0" id="welcome-text" style="text-align: left;">Welcome to CareDac</p>
        </div>

        <!-- Alert Messages -->
        <div id="alertContainer"></div>

        <!-- Signup Form -->
        <form id="signupForm" novalidate>

          <!-- Full Name -->
          <div class="mb-3">
            <label for="fullName" class="form-label fw-semibold" id="label-name">Full Name</label>
            <div class="input-group">
              <span class="input-group-text bg-white">
                <i class="bi bi-person text-muted"></i>
              </span>
              <input 
                type="text" 
                id="fullName"
                name="fullName"
                class="form-control border-start-0" 
                placeholder="Enter full name" 
                required
              />
            </div>
          </div>

          <!-- Date of Birth -->
          <div class="mb-3">
            <label for="dob" class="form-label fw-semibold" id="label-dob">Date of Birth</label>
            <div class="input-group">
              <span class="input-group-text bg-white">
                <i class="bi bi-calendar3 text-muted"></i>
              </span>
              <input 
                type="date" 
                id="dob"
                name="dob"
                class="form-control border-start-0" 
                max=""
                min=""
                required
              />
            </div>

          </div>

          <!-- Email -->
          <div class="mb-3">
            <label for="email" class="form-label fw-semibold" id="label-email">Email</label>
            <div class="input-group">
              <span class="input-group-text bg-white">
                <i class="bi bi-envelope text-muted"></i>
              </span>
              <input 
                type="email" 
                id="email"
                name="email"
                class="form-control border-start-0" 
                placeholder="Enter email" 
                required
              />
            </div>
            
          </div>

          
          <!-- Password -->
          <div class="mb-3">
            <label for="password" class="form-label fw-semibold" id="label-password">Password</label>
            <div class="input-group">
              <span class="input-group-text bg-white">
                <i class="bi bi-lock text-muted"></i>
              </span>
              <input 
                type="password" 
                id="password"
                name="password"
                class="form-control border-start-0 border-end-0" 
                placeholder="Enter password"
                required
              />
              <button 
                class="btn border bg-white password-toggle" 
                type="button" 
                onclick="togglePassword('password', this)"
                tabindex="-1"
              >
                <i class="bi bi-eye"></i>
              </button>
            </div>
          </div>

          <!-- Confirm Password -->
          <div class="mb-3">
            <label for="confirmPassword" class="form-label fw-semibold" id="label-confirm">Confirm Password</label>
            <div class="input-group">
              <span class="input-group-text bg-white">
                <i class="bi bi-lock text-muted"></i>
              </span>
              <input 
                type="password" 
                id="confirmPassword"
                name="confirmPassword"
                class="form-control border-start-0 border-end-0" 
                placeholder="Confirm password"
                required
              />
              <button 
                class="btn border bg-white password-toggle" 
                type="button" 
                onclick="togglePassword('confirmPassword', this)"
                tabindex="-1"
              >
                <i class="bi bi-eye"></i>
              </button>
            </div>
          </div>

          <!-- Mobile Number -->
          <div class="mb-3">
            <label for="mobile" class="form-label fw-semibold" id="label-mobile">Mobile Number</label>
            <div class="input-group">
              <span class="input-group-text bg-white">
                <i class="bi bi-telephone text-muted"></i>
              </span>
              <input 
                type="tel" 
                id="mobile"
                name="mobile"
                class="form-control border-start-0" 
                placeholder="Enter mobile number" 
                pattern="[0-9]{10,15}"
                required
              />
            </div>
          </div>


          <!-- Gender -->
          <div class="mb-4">
            <label class="form-label fw-semibold mb-2" id="label-gender">Gender</label>
            <div class="d-flex gap-3 flex-wrap">
              <div class="form-check">
                <input 
                  class="form-check-input" 
                  type="radio" 
                  name="gender" 
                  id="male" 
                  value="Male" 
                  checked
                />
                <label class="form-check-label fw-semibold" for="male" id="label-male">
                  Male
                </label>
              </div>
              <div class="form-check">
                <input 
                  class="form-check-input" 
                  type="radio" 
                  name="gender" 
                  id="female" 
                  value="Female"
                />
                <label class="form-check-label fw-semibold" for="female" id="label-female">
                  Female
                </label>
              </div>
              <div class="form-check">
                <input 
                  class="form-check-input" 
                  type="radio" 
                  name="gender" 
                  id="nonbinary" 
                  value="Non-Binary"
                />
                <label class="form-check-label fw-semibold" for="nonbinary" id="label-nonbinary">
                  Non-Binary
                </label>
              </div>
            </div>
          </div>

          <!-- Terms and Conditions -->
          <div class="mb-4">
            <div class="form-check">
              <input 
                class="form-check-input" 
                type="checkbox" 
                id="terms-check"
                required
              />
              <label class="form-check-label small" for="terms-check" id="label-terms">
                By continuing, you agree to our Terms and Conditions
              </label>
            </div>
          </div>

          <!-- Sign Up Button -->
          <button type="submit" class="btn btn-primary w-100 rounded-pill py-3 fw-semibold mb-3" id="btn-signup">
            Sign Up
          </button>

          <!-- Divider -->
          <div class="text-center">
            <small class="text-muted" id="label-login-text">Already have an account?</small>
            <a href="/login" class="text-primary text-decoration-none fw-semibold ms-1">Login</a>
          </div>

        </form>

      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // ==================== SET DATE CONSTRAINTS ====================
  const dobInput = document.getElementById('dob');
  const today = new Date();
  
  // Set max date to today (can't select future dates)
  const maxDate = today.toISOString().split('T')[0];
  dobInput.setAttribute('max', maxDate);
  
  // Set minimum date to 120 years ago (reasonable maximum age)
  const minAgeDate = new Date();
  minAgeDate.setFullYear(minAgeDate.getFullYear() - 120);
  const minDate = minAgeDate.toISOString().split('T')[0];
  dobInput.setAttribute('min', minDate);

  // ==================== PASSWORD TOGGLE ====================
  function togglePassword(id, el) {
    const input = document.getElementById(id);
    const icon = el.querySelector("i");
    
    if (input.type === "password") {
      input.type = "text";
      icon.classList.replace("bi-eye", "bi-eye-slash");
    } else {
      input.type = "password";
      icon.classList.replace("bi-eye-slash", "bi-eye");
    }
  }

  // ==================== PHONE NUMBER VALIDATION ====================
  const mobileInput = document.getElementById('mobile');
  
  mobileInput.addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/\D/g, '');
    if (e.target.value.length > 15) {
      e.target.value = e.target.value.slice(0, 15);
    }
  });

  // ==================== SHOW ALERT ====================
  function showAlert(message, type = 'danger') {
    const alertContainer = document.getElementById('alertContainer');
    alertContainer.innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        <i class="bi bi-${type === 'danger' ? 'exclamation-circle' : 'check-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
    
    setTimeout(() => {
      const alert = alertContainer.querySelector('.alert');
      if (alert) {
        alert.classList.remove('show');
        setTimeout(() => alert.remove(), 150);
      }
    }, 5000);
  }

  // ==================== AGE VALIDATION ====================
  function calculateAge(birthDate) {
    const today = new Date();
    const birth = new Date(birthDate);
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
      age--;
    }
    
    return age;
  }

  // ==================== MULTI-LANGUAGE SUPPORT ====================
  const lang = localStorage.getItem("lang") || "en";

  const text = {
    en: { 
      title: "Sign Up", 
      welcome: "Welcome to CareDac", 
      name: "Full Name", 
      dob: "Date of Birth", 
      email: "Email", 
      mobile: "Mobile Number", 
      password: "Password", 
      confirm: "Confirm Password", 
      gender: "Gender", 
      male: "Male", 
      female: "Female", 
      nonbinary: "Non-Binary", 
      terms: "By continuing, you agree to our Terms and Conditions", 
      signup: "Sign Up", 
      logintext: "Already have an account?" 
    },
    ms: { 
      title: "Daftar", 
      welcome: "Selamat datang ke CareDac", 
      name: "Nama Penuh", 
      dob: "Tarikh Lahir", 
      email: "E-mel", 
      mobile: "Nombor Telefon", 
      password: "Kata Laluan", 
      confirm: "Sahkan Kata Laluan", 
      gender: "Jantina", 
      male: "Lelaki", 
      female: "Perempuan", 
      nonbinary: "Bukan Binari", 
      terms: "Dengan meneruskan, anda bersetuju dengan Terma dan Syarat kami", 
      signup: "Daftar", 
      logintext: "Sudah mempunyai akaun?" 
    },
    th: { 
      title: "สมัครสมาชิก", 
      welcome: "ยินดีต้อนรับสู่ CareDac", 
      name: "ชื่อเต็ม", 
      dob: "วันเดือนปีเกิด", 
      email: "อีเมล", 
      mobile: "หมายเลขโทรศัพท์", 
      password: "รหัสผ่าน", 
      confirm: "ยืนยันรหัสผ่าน", 
      gender: "เพศ", 
      male: "ชาย", 
      female: "หญิง", 
      nonbinary: "ไม่ระบุเพศ", 
      terms: "เมื่อดำเนินการต่อ คุณยอมรับข้อกำหนดและเงื่อนไขของเรา", 
      signup: "สมัครสมาชิก", 
      logintext: "มีบัญชีอยู่แล้ว?" 
    },
    id: { 
      title: "Daftar", 
      welcome: "Selamat datang di CareDac", 
      name: "Nama Lengkap", 
      dob: "Tanggal Lahir", 
      email: "Email", 
      mobile: "Nomor Ponsel", 
      password: "Kata Sandi", 
      confirm: "Konfirmasi Kata Sandi", 
      gender: "Jenis Kelamin", 
      male: "Pria", 
      female: "Wanita", 
      nonbinary: "Non-Biner", 
      terms: "Dengan melanjutkan, Anda setuju dengan Syarat dan Ketentuan kami", 
      signup: "Daftar", 
      logintext: "Sudah punya akun?" 
    }
  };

  // ==================== APPLY LANGUAGE (SAFE VERSION) ====================
  const t = text[lang];
  if (t) {
    // Helper function to safely set text content
    function safeSetText(id, text) {
      const element = document.getElementById(id);
      if (element) element.textContent = text;
    }

    safeSetText("signup-title", t.title);
    safeSetText("welcome-text", t.welcome);
    safeSetText("label-name", t.name);
    safeSetText("label-dob", t.dob);
    safeSetText("label-email", t.email);
    safeSetText("label-mobile", t.mobile);
    safeSetText("label-password", t.password);
    safeSetText("label-confirm", t.confirm);
    safeSetText("label-gender", t.gender);
    safeSetText("label-male", t.male);
    safeSetText("label-female", t.female);
    safeSetText("label-nonbinary", t.nonbinary);
    safeSetText("btn-signup", t.signup);
    safeSetText("label-login-text", t.logintext);
    
    // Handle terms label specially (preserve the link)
    const termsLabel = document.getElementById("label-terms");
    if (termsLabel) {
      termsLabel.innerHTML = t.terms.replace(
        'Terms and Conditions',
        '<a href="#" class="text-primary">Terms and Conditions</a>'
      );
    }
  }

  // ==================== FORM SUBMISSION WITH VALIDATION ====================
  document.getElementById('signupForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    console.log('Form submitted!'); // Debug log
    
    // Clear previous alerts
    document.getElementById('alertContainer').innerHTML = '';
    
    // Get form data
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    console.log('Form data:', data); // Debug log
    
    // Validate full name
    if (!data.fullName || data.fullName.trim().length < 2) {
      showAlert('Please enter a valid full name', 'danger');
      document.getElementById('fullName').focus();
      return;
    }
    
    // Validate date of birth
    if (!data.dob) {
      showAlert('Please select your date of birth', 'danger');
      dobInput.focus();
      return;
    }
    
    // Calculate age
    const age = calculateAge(data.dob);
    
    // Validate age
    if (age > 120) {
      showAlert('Please enter a valid date of birth', 'danger');
      dobInput.focus();
      return;
    }
    
    if (age < 0) {
      showAlert('Date of birth cannot be in the future', 'danger');
      dobInput.focus();
      return;
    }
    
    // Validate email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(data.email)) {
      showAlert('Please enter a valid email address', 'danger');
      document.getElementById('email').focus();
      return;
    }
    
    // Validate mobile number
    if (!data.mobile || data.mobile.length < 10) {
      showAlert('Please enter a valid mobile number (at least 10 digits)', 'danger');
      mobileInput.focus();
      return;
    }
    
    // Validate password
    if (!data.password || data.password.length < 6) {
      showAlert('Password must be at least 6 characters long', 'danger');
      document.getElementById('password').focus();
      return;
    }
    
    // Validate passwords match
    if (data.password !== data.confirmPassword) {
      showAlert('Passwords do not match', 'danger');
      document.getElementById('confirmPassword').focus();
      return;
    }
    
    // Validate terms accepted
    if (!document.getElementById('terms-check').checked) {
      showAlert('Please accept the terms and conditions', 'danger');
      return;
    }
    
    // Add age to data
    data.age = age;
    data.isMinor = age < 18;
    
    console.log('All validations passed!', data); // Debug log
    
    // Show loading state
    const submitBtn = document.getElementById('btn-signup');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating account...';
    submitBtn.disabled = true;
    
    // Store flow context
    localStorage.setItem('authFlow', 'signup');
    localStorage.setItem('userEmail', data.email);
    localStorage.setItem('userName', data.fullName);
    localStorage.setItem('userAge', data.age);
    localStorage.setItem('isMinor', data.isMinor);
    sessionStorage.setItem('signupData', JSON.stringify(data));
    
    // ==================== DEMO SIMULATION ====================
    console.log('Starting redirect simulation...'); // Debug log
    
    setTimeout(() => {
      const ageMsg = data.isMinor ? ' (Parent/Guardian consent required)' : '';
      showAlert('Registration successful!' + ageMsg + ' Redirecting to OTP verification...', 'success');
      
      setTimeout(() => {
        console.log('Redirecting to OTP page...'); // Debug log
        window.location.href = '/otp?from=signup';
      }, 1500);
    }, 1500);
  });

  console.log('Signup page script loaded successfully!'); // Debug log
</script>
{% endblock %}
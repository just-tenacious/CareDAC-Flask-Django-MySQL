{% extends "base-auth.html" %}

{% block title %}Who Needs Care - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
  /* ==================== MINIMAL CUSTOM STYLES ==================== */
  body {
    background-color: #f9fafb;
  }

  .care-container {
    min-height: calc(100vh - 72px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem 0;
  }

  .care-card {
    max-width: 480px;
    width: 100%;
  }

  .page-step {
    display: none;
    animation: fadeIn 0.4s ease;
  }

  .page-step.active {
    display: block;
  }

  @keyframes fadeIn {
    from { 
      opacity: 0; 
      transform: translateY(10px); 
    }
    to { 
      opacity: 1; 
      transform: translateY(0); 
    }
  }

  /* Progress Steps */
  .progress-steps {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2rem;
    position: relative;
  }

  .progress-steps::before {
    content: '';
    position: absolute;
    top: 15px;
    left: 0;
    right: 0;
    height: 2px;
    background: #e5e7eb;
    z-index: 0;
  }

  .progress-step {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: white;
    border: 2px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
    color: #9ca3af;
    position: relative;
    z-index: 1;
    transition: all 0.3s;
  }

  .progress-step.active {
    background: #1e40af;
    border-color: #1e40af;
    color: white;
  }

  .progress-step.completed {
    background: #22c55e;
    border-color: #22c55e;
    color: white;
  }

  /* Option Buttons for Step 1 */
  .option-btn {
    border: 1.5px solid #d1d5db;
    border-radius: 12px;
    padding: 1rem;
    font-size: 1rem;
    font-weight: 600;
    color: #111827;
    background: white;
    width: 100%;
    text-align: center;
    margin-bottom: 0.75rem;
    transition: all 0.2s ease;
    cursor: pointer;
    position: relative;
  }

  .option-btn:hover {
    border-color: #1e40af;
    background: #eff6ff;
    color: #1e40af;
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(30, 64, 175, 0.1);
  }

  .option-btn:active {
    transform: translateY(0);
  }

  .option-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  @media (max-width: 576px) {
    .care-container {
      padding: 1rem;
    }

    .option-btn {
      font-size: 0.95rem;
      padding: 0.85rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container care-container">
  <div class="care-card px-3">
    
    <!-- Card -->
    <div class="card border-0 shadow-sm rounded-3">
      <div class="card-body p-4 p-md-5">
        
        <!-- Progress Steps Indicator -->
        <!--<div class="progress-steps mb-4">
          <div class="progress-step active" id="step-indicator-1">1</div>
          <div class="progress-step" id="step-indicator-2">2</div>
          <div class="progress-step" id="step-indicator-3">3</div>
        </div> -->

        <!-- ==================== STEP 1: WHO NEEDS CARE ==================== -->
        <div id="page1" class="page-step active">
          <div class="text-center mb-4">
            <h4 class="fw-bold mb-2" id="title-step1">Who needs care?</h4>
            <p class="text-muted small mb-0" id="subtitle-step1">Select who requires care services</p>
          </div>

          <button class="btn option-btn" data-choice="My Self" data-type="self">
            <i class="bi bi-person me-2"></i>My Self
          </button>
          <button class="btn option-btn" data-choice="My Child" data-type="other">
            <i class="bi bi-people me-2"></i>My Child
          </button>
          <button class="btn option-btn" data-choice="My Partner" data-type="other">
            <i class="bi bi-heart me-2"></i>My Partner
          </button>
          <button class="btn option-btn" data-choice="My Client" data-type="other">
            <i class="bi bi-briefcase me-2"></i>My Client
          </button>
          <button class="btn option-btn" data-choice="Other" data-type="other">
            <i class="bi bi-plus-circle me-2"></i>Other
          </button>
        </div>

        <!-- ==================== STEP 2: INFO ==================== -->
        <div id="page2" class="page-step">
          <div class="text-center mb-4">
            <h4 class="fw-bold mb-2" id="title-step2">Info</h4>
            <p class="text-muted small mb-0" id="subtitle-step2">Enter care recipient details</p>
          </div>

          <form id="infoForm">
            
            <!-- Age -->
            <div class="mb-3">
              <label for="age" class="form-label fw-semibold" id="label-age">Age</label>
              <input 
                type="number" 
                class="form-control" 
                id="age" 
                name="age"
                placeholder="Enter Age" 
                min="0"
                max="120"
                required
              />
            </div>

            <!-- Postcode -->
            <div class="mb-3">
              <label for="postcode" class="form-label fw-semibold" id="label-postcode">Postcode</label>
              <input 
                type="text" 
                class="form-control" 
                id="postcode"
                name="postcode" 
                placeholder="Enter Postcode" 
                required
              />
            </div>

            <!-- Need help to -->
            <div class="mb-4">
              <label class="form-label fw-semibold mb-3" id="label-needhelp">Need help to</label>
              
              <div class="form-check mb-2">
                <input 
                  class="form-check-input" 
                  type="radio" 
                  name="helpOption" 
                  id="help1" 
                  value="Find a provider" 
                  checked
                />
                <label class="form-check-label" for="help1" id="label-help1">
                  Find a provider
                </label>
              </div>

              <div class="form-check mb-2">
                <input 
                  class="form-check-input" 
                  type="radio" 
                  name="helpOption" 
                  id="help2" 
                  value="Be ready for a plan"
                />
                <label class="form-check-label" for="help2" id="label-help2">
                  Be ready for a plan
                </label>
              </div>

              <div class="form-check mb-2">
                <input 
                  class="form-check-input" 
                  type="radio" 
                  name="helpOption" 
                  id="help3" 
                  value="Apply for NDIS"
                />
                <label class="form-check-label" for="help3" id="label-help3">
                  Apply for NDIS
                </label>
              </div>
            </div>

            <!-- Buttons -->
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-outline-secondary rounded-pill flex-fill" onclick="showStep(1)" id="btn-back-step2">
                <i class="bi bi-arrow-left me-1"></i>Back
              </button>
              <button type="submit" class="btn btn-primary rounded-pill flex-fill" id="btn-next-step2">
                Next<i class="bi bi-arrow-right ms-1"></i>
              </button>
            </div>
          </form>
        </div>

        <!-- ==================== STEP 3: SERVICES ==================== -->
        <div id="page3" class="page-step">
          <div class="text-center mb-4">
            <h4 class="fw-bold mb-2" id="title-step3">Service I need</h4>
            <p class="text-muted small mb-0" id="subtitle-step3">Select all services that apply</p>
          </div>

          <form id="serviceForm">
            
            <div class="form-check mb-3">
              <input 
                class="form-check-input" 
                type="checkbox" 
                id="service1" 
                name="services[]"
                value="Personal care"
              />
              <label class="form-check-label" for="service1" id="label-service1">
                Personal care
              </label>
            </div>

            <div class="form-check mb-3">
              <input 
                class="form-check-input" 
                type="checkbox" 
                id="service2"
                name="services[]" 
                value="Domestic Assistance"
              />
              <label class="form-check-label" for="service2" id="label-service2">
                Domestic Assistance
              </label>
            </div>

            <div class="form-check mb-3">
              <input 
                class="form-check-input" 
                type="checkbox" 
                id="service3"
                name="services[]" 
                value="Social Support & Community Participation"
              />
              <label class="form-check-label" for="service3" id="label-service3">
                Social Support & Community Participation
              </label>
            </div>

            <div class="form-check mb-3">
              <input 
                class="form-check-input" 
                type="checkbox" 
                id="service4"
                name="services[]" 
                value="Specialist Care"
              />
              <label class="form-check-label" for="service4" id="label-service4">
                Specialist Care
              </label>
            </div>

            <div class="form-check mb-3">
              <input 
                class="form-check-input" 
                type="checkbox" 
                id="service5"
                name="services[]" 
                value="Out and About Transport"
              />
              <label class="form-check-label" for="service5" id="label-service5">
                Out and About Transport
              </label>
            </div>

            <div class="form-check mb-3">
              <input 
                class="form-check-input" 
                type="checkbox" 
                id="service6"
                name="services[]" 
                value="Relief Respite Care"
              />
              <label class="form-check-label" for="service6" id="label-service6">
                Relief Respite Care
              </label>
            </div>

            <div class="form-check mb-3">
              <input 
                class="form-check-input" 
                type="checkbox" 
                id="service7"
                name="services[]" 
                value="Coaching & Counselling"
              />
              <label class="form-check-label" for="service7" id="label-service7">
                Coaching & Counselling
              </label>
            </div>

            <div class="form-check mb-4">
              <input 
                class="form-check-input" 
                type="checkbox" 
                id="service8"
                name="services[]" 
                value="Disability Products"
              />
              <label class="form-check-label" for="service8" id="label-service8">
                Disability Products
              </label>
            </div>

            <!-- Buttons -->
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-outline-secondary rounded-pill flex-fill" onclick="showStep(2)" id="btn-back-step3">
                <i class="bi bi-arrow-left me-1"></i>Back
              </button>
              <button type="submit" class="btn btn-primary rounded-pill flex-fill" id="btn-complete">
                Complete<i class="bi bi-check-lg ms-1"></i>
              </button>
            </div>
          </form>
        </div>

      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // ==================== FLOW VERIFICATION ====================
  const authFlow = localStorage.getItem('authFlow');

  if (authFlow !== 'signup') {
    console.warn('Unauthorized access - user should complete signup first');
    // In production, redirect to signup
    // window.location.href = '/register';
  }

  // ==================== STEP NAVIGATION ====================
  let currentStep = 1;
  const totalSteps = 3;

  // Store form data with clear flow type
  const careData = {
    flowType: '',        // 'self' or 'other'
    whoNeedsCare: '',    // 'My Self', 'My Child', etc.
    age: '',
    postcode: '',
    helpOption: '',
    services: []
  };

  function showStep(step) {
    /*if (step < 1 || step > totalSteps) return;*/

    // Hide all steps
    document.querySelectorAll('.page-step').forEach(page => {
      page.classList.remove('active');
    });

    // Show current step
    document.getElementById('page' + step).classList.add('active');
    currentStep = step;

    // Update progress indicators
    updateProgressIndicators();

    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function updateProgressIndicators() {
    for (let i = 1; i <= totalSteps; i++) {
      const indicator = document.getElementById('step-indicator-' + i);
      
      if (i < currentStep) {
        indicator.classList.add('completed');
        indicator.classList.remove('active');
        indicator.innerHTML = '<i class="bi bi-check"></i>';
      } else if (i === currentStep) {
        indicator.classList.add('active');
        indicator.classList.remove('completed');
        indicator.textContent = i;
      } else {
        indicator.classList.remove('active', 'completed');
        indicator.textContent = i;
      }
    }
  }

  // ==================== STEP 1: WHO NEEDS CARE ====================
  document.querySelectorAll('.option-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const choice = this.getAttribute('data-choice');
      const flowType = this.getAttribute('data-type'); // 'self' or 'other'
      
      careData.whoNeedsCare = choice;
      careData.flowType = flowType;
      
      console.log('Selected:', choice, '| Flow type:', flowType);
      
      // Show loading state
      this.disabled = true;
      const originalHTML = this.innerHTML;
      this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
      
      // Store in sessionStorage
      sessionStorage.setItem('careData', JSON.stringify(careData));
      
      // ==================== FLOW SEPARATION ====================
      if (flowType === 'self') {
        // ========== MY SELF FLOW ==========
        console.log('→ MY SELF: Direct redirect to member details page');
        
        // Store flags for member details page
        localStorage.setItem('careFlowType', 'self');
        localStorage.setItem('careWho', choice);
        
        // Pre-fill with user's signup data if available
        const signupData = sessionStorage.getItem('signupData');
        if (signupData) {
          const userData = JSON.parse(signupData);
          localStorage.setItem('preFillMemberData', JSON.stringify({
            fullName: userData.fullName,
            email: userData.email,
            mobile: userData.mobile,
            dob: userData.dob,
            gender: userData.gender,
            age: userData.age
          }));
        }
        
        // Redirect to member details page with 'self' type
        setTimeout(() => {
          window.location.href = '/enter-member-details?type=self';
        }, 500);
        
      } else {
        // ========== OTHER FLOW (Child/Partner/Client/Other) ==========
        console.log('→ OTHER: Continue to step 2 for additional information');
        
        // Store flags
        localStorage.setItem('careFlowType', 'other');
        localStorage.setItem('careWho', choice);
        localStorage.removeItem('preFillMemberData'); // Clear any pre-fill data
        
        // Continue to step 2
        setTimeout(() => {
          this.disabled = false;
          this.innerHTML = originalHTML;
          showStep(2);
        }, 300);
      }
    });
  });

  // ==================== STEP 2: INFO FORM ====================
  document.getElementById('infoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Get form data
    const formData = new FormData(this);
    careData.age = formData.get('age');
    careData.postcode = formData.get('postcode');
    careData.helpOption = formData.get('helpOption');
    
    // Validate age
    if (careData.age < 0 || careData.age > 120) {
      alert('Please enter a valid age between 0 and 120');
      return;
    }
    
    // Validate postcode
    if (!careData.postcode || careData.postcode.trim().length < 3) {
      alert('Please enter a valid postcode');
      return;
    }
    
    console.log('Info submitted:', careData);
    
    // Store in sessionStorage
    sessionStorage.setItem('careData', JSON.stringify(careData));
    
    // Move to next step
    showStep(3);
  });

  // ==================== STEP 3: SERVICES FORM ====================
  document.getElementById('serviceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Get selected services
    const selectedServices = [];
    document.querySelectorAll('#serviceForm input[type="checkbox"]:checked').forEach(checkbox => {
      selectedServices.push(checkbox.value);
    });

    // Validate at least one service selected
    if (selectedServices.length === 0) {
      alert('Please select at least one service');
      return;
    }

    careData.services = selectedServices;
    
    console.log('Complete care data:', careData);
    
    // Store final data
    sessionStorage.setItem('careData', JSON.stringify(careData));
    localStorage.setItem('careServices', JSON.stringify(selectedServices));
    
    // Show loading state
    const submitBtn = document.getElementById('btn-complete');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
    submitBtn.disabled = true;

    // ==================== BACKEND API CALL (UNCOMMENT WHEN READY) ====================
    /*
    fetch('/api/care-needs', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify(careData)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Redirect to patient details page for 'other' flow
        window.location.href = '/enter-patient-details';
      } else {
        alert('Failed to save data. Please try again.');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Network error. Please try again.');
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    });
    */

    // For demo: Simulate API call and redirect to patient details
    setTimeout(() => {
      console.log('→ Redirecting to patient details page (OTHER flow)');
      // Redirect to PATIENT details page (not member details)
      window.location.href = '/enter-patient-details';
    }, 1000);
  });

  // ==================== LOAD SAVED DATA (if user goes back) ====================
  window.addEventListener('load', function() {
    const savedData = sessionStorage.getItem('careData');
    
    if (savedData) {
      const data = JSON.parse(savedData);
      
      // Restore age and postcode
      if (data.age) document.getElementById('age').value = data.age;
      if (data.postcode) document.getElementById('postcode').value = data.postcode;
      
      // Restore help option
      if (data.helpOption) {
        document.querySelectorAll('input[name="helpOption"]').forEach(radio => {
          if (radio.value === data.helpOption) {
            radio.checked = true;
          }
        });
      }
      
      // Restore services
      if (data.services && data.services.length > 0) {
        document.querySelectorAll('input[name="services[]"]').forEach(checkbox => {
          if (data.services.includes(checkbox.value)) {
            checkbox.checked = true;
          }
        });
      }
    }
  });

  // ==================== KEYBOARD NAVIGATION ====================
  document.addEventListener('keydown', function(e) {
    // Prevent navigation during form input
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      return;
    }

    // Arrow key navigation (only for back)
    if (e.key === 'ArrowLeft' && currentStep > 1) {
      showStep(currentStep - 1);
    }
  });

  console.log('Who needs care page loaded successfully!');
</script>
{% endblock %}
{% extends "base-auth.html" %}

{% block title %}Forgot Password - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
  /* ==================== MINIMAL CUSTOM STYLES ==================== */
  body {
    background-color: #f9fafb;
  }

  .forgot-container {
    min-height: calc(100vh - 72px);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .forgot-card {
    max-width: 480px;
    width: 100%;
  }

  @media (max-width: 576px) {
    .forgot-container {
      padding: 1rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container forgot-container">
  <div class="forgot-card">
    
    <!-- Card -->
    <div class="card border-0 shadow-sm rounded-3">
      <div class="card-body p-4 p-md-5">
        
        <!-- Icon -->
        <div class="text-center mb-4">
          <div class="mb-3">
          <!--  <i class="bi bi-key text-primary" style="font-size: 3rem;"></i> -->
          </div>
          <h2 class="fw-bold mb-2" id="forgotTitle" style="text-align: left;" >Forgot your password?</h2>
          <p class="small mb-0" id="forgotSubtitle" style="text-align: left;">
            Get a secure one-time link to log in<br>without needing to enter a password.
          </p>
        </div>

        <!-- Forgot Password Form -->
        <form id="forgotForm">
          
          <!-- Email Input -->
          <div class="mb-4">
            <label for="email" class="form-label fw-semibold" id="emailLabel">Email</label>
            <div class="input-group">
              <span class="input-group-text bg-white">
                <i class="bi bi-envelope text-muted"></i>
              </span>
              <input 
                type="email" 
                class="form-control border-start-0" 
                id="email" 
                name="email"
                placeholder="Enter email" 
                required 
              />
            </div>
            <small class="text-muted mt-2 d-block">
              We'll send you an OTP to reset your password
            </small>
          </div>

          <!-- Submit Button -->
          <div class="d-grid mb-3">
            <button type="submit" class="btn btn-primary rounded-pill py-3 fw-semibold" id="submitBtn">
              Send OTP
            </button>
          </div>

          <!-- Back to Login Link -->
          <div class="text-center">
            <a href="/login" class="text-primary text-decoration-none fw-semibold" id="backToLogin">
              <i class="bi bi-arrow-left me-1"></i>
              Back to Login
            </a>
          </div>

        </form>

      </div>
    </div>

    <!-- Help Text -->
    <!-- 
    <div class="text-center mt-4">
      <small class="text-muted">
        Need help? <a href="/contact" class="text-primary text-decoration-none">Contact Support</a>
      </small>
    </div>
     -->
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // ==================== MULTI-LANGUAGE SUPPORT ====================
  const lang = localStorage.getItem("lang") || "en";

  const translations = {
    en: {
      title: "Forgot your password?",
      subtitle: "Get a secure one-time link to log in without needing to enter a password.",
      emailLabel: "Email",
      emailPlaceholder: "Enter email",
      submitBtn: "Send OTP",
      backToLogin: "Back to Login",
      helpText: "We'll send you an OTP to reset your password"
    },
    ms: {
      title: "Terlupa kata laluan anda?",
      subtitle: "Dapatkan pautan sekali sahaja untuk log masuk tanpa perlu memasukkan kata laluan.",
      emailLabel: "E-mel",
      emailPlaceholder: "Masukkan e-mel",
      submitBtn: "Hantar OTP",
      backToLogin: "Kembali ke Log Masuk",
      helpText: "Kami akan menghantar OTP untuk menetapkan semula kata laluan anda"
    },
    th: {
      title: "ลืมรหัสผ่าน?",
      subtitle: "รับลิงก์แบบใช้ครั้งเดียวเพื่อเข้าสู่ระบบโดยไม่ต้องใส่รหัสผ่าน",
      emailLabel: "อีเมล",
      emailPlaceholder: "กรอกอีเมล",
      submitBtn: "ส่ง OTP",
      backToLogin: "กลับไปเข้าสู่ระบบ",
      helpText: "เราจะส่ง OTP เพื่อรีเซ็ตรหัสผ่านของคุณ"
    },
    id: {
      title: "Lupa kata sandi Anda?",
      subtitle: "Dapatkan tautan sekali pakai untuk masuk tanpa perlu memasukkan kata sandi.",
      emailLabel: "Email",
      emailPlaceholder: "Masukkan email",
      submitBtn: "Kirim OTP",
      backToLogin: "Kembali ke Login",
      helpText: "Kami akan mengirimkan OTP untuk mereset kata sandi Anda"
    }
  };

  // Apply language
  const t = translations[lang];
  if (t) {
    document.getElementById("forgotTitle").textContent = t.title;
    
    // Update subtitle with line breaks
    const subtitleEl = document.getElementById("forgotSubtitle");
    subtitleEl.innerHTML = t.subtitle.replace(/\n/g, '<br>');
    
    document.getElementById("emailLabel").textContent = t.emailLabel;
    document.getElementById("email").placeholder = t.emailPlaceholder;
    document.getElementById("submitBtn").textContent = t.submitBtn;
    
    // Update back to login text while keeping icon
    const backToLoginEl = document.getElementById("backToLogin");
    backToLoginEl.innerHTML = `<i class="bi bi-arrow-left me-1"></i>${t.backToLogin}`;
  }

  // ==================== FORM VALIDATION ====================
  const emailInput = document.getElementById('email');
  
  // Email validation on blur
  emailInput.addEventListener('blur', function() {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (this.value && !emailRegex.test(this.value)) {
      this.classList.add('is-invalid');
      
      // Add error message if doesn't exist
      if (!this.parentElement.querySelector('.invalid-feedback')) {
        const errorMsg = document.createElement('div');
        errorMsg.className = 'invalid-feedback';
        errorMsg.textContent = 'Please enter a valid email address';
        this.parentElement.appendChild(errorMsg);
      }
    } else {
      this.classList.remove('is-invalid');
      const errorMsg = this.parentElement.querySelector('.invalid-feedback');
      if (errorMsg) {
        errorMsg.remove();
      }
    }
  });

  // ==================== FORM SUBMISSION WITH FLOW CONTROL ====================
  document.getElementById('forgotForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const email = document.getElementById('email').value.trim();
    
    if (!email) {
      alert('Please enter your email address.');
      return;
    }

    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      alert('Please enter a valid email address.');
      return;
    }

    console.log('Password reset requested for:', email);
    
    // Show loading state
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.textContent;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
    submitBtn.disabled = true;

    // ==================== IMPORTANT: FLOW CONTROL ====================
    // Store the flow context
    localStorage.setItem('authFlow', 'forgot-password');
    localStorage.setItem('userEmail', email);

    // In production: Send to backend
    // fetch('/api/forgot-password', {
    //   method: 'POST',
    //   headers: { 'Content-Type': 'application/json' },
    //   body: JSON.stringify({ email: email })
    // })
    // .then(response => response.json())
    // .then(data => {
    //   if (data.success) {
    //     // OTP sent, redirect to verification
    //     window.location.href = '/otp?from=forgot-password';
    //   } else {
    //     alert(data.message || 'Email not found');
    //     submitBtn.textContent = originalText;
    //     submitBtn.disabled = false;
    //   }
    // })
    // .catch(error => {
    //   alert('Error sending OTP. Please try again.');
    //   submitBtn.textContent = originalText;
    //   submitBtn.disabled = false;
    // });

    // For demo: Simulate API call
    setTimeout(() => {
      alert(`A password reset OTP has been sent to ${email}`);
      
      // Redirect to OTP page with context
      window.location.href = '/otp?from=forgot-password';
    }, 1500);
  });

  // ==================== AUTO-FILL EMAIL IF COMING FROM LOGIN ====================
  // If user was previously trying to login, pre-fill email
  const savedEmail = localStorage.getItem('userEmail');
  if (savedEmail && document.referrer.includes('/login')) {
    document.getElementById('email').value = savedEmail;
  }
</script>
{% endblock %}